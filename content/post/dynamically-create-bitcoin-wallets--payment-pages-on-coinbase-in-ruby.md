+++
title = "Dynamically Create BitCoin Wallets & Payment Pages on Coinbase in Ruby"
date = 2014-02-11T16:53:00Z
updated = 2014-02-17T00:29:41Z
tags = ["Ruby on Rails", "Coinbase", "BitCoin"]
blogimport = true 
[author]
	name = "Claude"
	uri = "https://www.blogger.com/profile/06379003436141860057"
+++

Last weekend, as part of my new year's resolution to dedicate some time to good causes, I participated in <a href="http://hack4good.io/" target="_blank">Hack4good</a>: a global 48 hour hackathon aimed at bringing ideas for the social good into life. In Malta, our team brought forward a crowd funding solution for charitable fundraisers with <b>minimal</b> transaction fees. To this end, we selected <a href="https://www.youtube.com/watch?v=Um63OQz3bjo" target="_blank">BitCoin</a> as the donation currency and <a href="https://coinbase.com/" target="_blank">Coinbase</a> to host fundraise donations.<br /><br />One requirement in our project was to have Coinbase automatically issue a BitCoin wallet to each&nbsp;fundraiser. To further complicate matters, we wanted to generate a Coinbase payment page that allows the donor to&nbsp;transfer his BitCoins to the fundraiser's wallet:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-9URc-UR2bBg/UvouzVJqjUI/AAAAAAAAAHY/VTX_OUmsRW4/s1600/coinbase-payment-page.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-9URc-UR2bBg/UvouzVJqjUI/AAAAAAAAAHY/VTX_OUmsRW4/s1600/coinbase-payment-page.png" height="400" width="392" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><a href="https://coinbase.com/api/doc" target="_blank">Coinbase's awesome API</a> permitted us to do both things with very little effort. Since we developed the solution in Ruby on Rails 4, I'll show you the code of how we accomplished this using a <a href="https://github.com/claudemamo/coinbase-ruby" target="_blank">forked version of Coinbase API's Ruby client</a> [1]:<br /><br /><script src="https://gist.github.com/claudemamo/8918100.js?file=fundraiser_controller(1).rb"></script>The&nbsp;<i>create()</i>&nbsp;controller action does numerous things so let's dissect it piece by piece. The action instantiates the Coinbase client with our API key: this key is created in Coinbase's account settings page. The client object's <i>create_user(...)</i> method is then invoked to make a wallet in addition to a Coinbase account for the fundraiser. The email address and password parameters are used by the end-user to access his fundraiser wallet on Coinbase. <i>COINBASE_CLIENT_SECRET</i>, linked to our API key, is passed as a parameter so that we can automatically grant ourselves merchant permissions on the created user account. These permissions are needed to dynamically generate the payment page on behalf of the user.<br /><br />Making the call to Coinbase to generate the payment page requires that we follow the OAuth 2 protocol [2]. Fortunately, an&nbsp;<a href="https://rubygems.org/gems/oauth2" target="_blank">OAuth 2 Ruby library</a> exists. So we go ahead and use the library to instantiate an OAuth client, passing <i>COINBASE_API_KEY</i> and <i>COINBASE_API_SECRET</i> as parameters. Before we ask Coinbase to create a payment page on the user's behalf, an&nbsp;<i>AccessToken</i> object is constructed with the access token obtained from&nbsp;<i>coinbase</i>.<i>create_user(...)</i>&nbsp;and the OAuth client we have just instantiated. After this, we use the newly constructed&nbsp;<i>oauth_token</i>&nbsp;object to post a request to&nbsp;<i>https://coinbase.com/api/v1/buttons.</i>&nbsp;Note that <i>JSON_CREATE_PAYMENT_PAGE</i>'s value is sent as the HTTP body.<br /><br />All I need from the JSON response returned from the API call is the payment page code. This code lets Coinbase know which payment page to display. We persist this code along with the fundraiser details so that we can retrieve them later when we show the fundraiser to a potential donor:<br /><br /><script src="https://gist.github.com/claudemamo/8918100.js?file=fundraiser_controller(2).rb"></script>Here is view associated with the above action:<br /><br /><script src="https://gist.github.com/claudemamo/8918100.js?file=show.html.erb"></script>The view gets the page code from&nbsp;<i>@fundraiser.coinbase_page_code</i> and sets the necessary HTML attributes with this value. <i>button.js</i>&nbsp;is a script provided by Coinbase that styles the anchor element and opens the fundraising donation page tied to the page code when the anchor is clicked:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-216Y0Y3NHe8/Uvoo9rAJu5I/AAAAAAAAAHM/yQWlxI-KSEE/s1600/donation_large.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-216Y0Y3NHe8/Uvoo9rAJu5I/AAAAAAAAAHM/yQWlxI-KSEE/s1600/donation_large.png" /></a></div><br />The final step is to add the OAuth 2 and Coinbase dependencies to the project Gemfile:<br /><br /><script src="https://gist.github.com/claudemamo/8918100.js?file=Gemfile"></script><br /><div style="text-align: justify;"><span class="num" style="font-family: Times, 'Times New Roman', serif;">1: We forked <a href="https://github.com/coinbase/coinbase-ruby" target="_blank">Coinbase's Ruby client</a> because <i>create_user(...)</i>&nbsp;didn't support&nbsp;<a href="https://coinbase.com/api/doc/1.0/users/create.html" target="_blank">client ID</a>.</span></div><div style="text-align: justify;"><span class="num" style="font-family: Times, 'Times New Roman', serif;">2: You need to register your application on Coinbase before you can gain rights to manage user accounts through OAuth.&nbsp;</span></div>
