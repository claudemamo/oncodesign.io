+++
title = "Dynamically Create Rules using Drools & Rule Templates"
date = 2015-08-10T15:12:00Z
updated = 2015-08-15T17:18:10Z
tags = ["Drools"]
blogimport = true
[author]
	name = "Claude"
	uri = "https://www.blogger.com/profile/06379003436141860057"
+++

Rules are used for a variety of stuff in the systems we build. Most often these rules are hard-coded in our application logic. The trouble is that sometimes we want to have the end-user the ability to define his own rules. Imagine an order processing system. The supplier wants to be notified on any range of events as they occur throughout the system but the notification rules are not known ahead of time. Such a rule could be for a late payment or a highly lucrative order event. In Java, the latter rule can be modelled as follows [1]:<br /><script src="https://gist.github.com/claudemamo/50736b6ff70f75ae8bd7.js?file=Program(1).java"></script>Supporting conjoined conditions in a rule requires us that we tweak the previous example:<br /><br /><script src="https://gist.github.com/claudemamo/50736b6ff70f75ae8bd7.js?file=Program(2).java"></script>I consider it a risky proposition to write your own primitive rules engine to evaluate rules like the above. I much prefer a solution leveraging Drools 6 in combination with <b><a href="https://docs.jboss.org/drools/release/6.2.0.Final/drools-docs/html_single/#d0e5627" target="_blank">Rule Templates</a></b>. Rule Templates is an awesome Drools feature giving you the ability to define abstract rules at design-time. At run-time, a Drools compiler runs through the rule template and evaluates expressions to generate concrete rules. Given an event type class (e.g., <i>OrderEvent</i>) and a <i>Rule</i> object (e.g.,&nbsp;<i>highValueOrderWidgetsIncRule</i>), we can conceive the following rule template:<br /><br /><script src="https://gist.github.com/claudemamo/50736b6ff70f75ae8bd7.js?file=template.drl"></script>A couple of things to observe:<br /><ul><li>Line 1: Declares that the DRL file is a rule template.</li></ul><ul><li>Line 3-4: <i>rule</i> and <i>eventType</i> are template parameters.</li></ul><ul><li>Line 8: <i>alertDecision</i> is global variable which we write the outcome to should the rule evaluate to true.</li></ul><ul><li>Line 12: <i>@{row.rowNumber}</i> is an in-built expression that makes the rule ID unique. This is useful for situations when you don't know how many rules you're going to have ahead of time. Note that this doesn't apply to our example.</li></ul><ul><li>Line 14: <i>@{eventType}</i> and <i>@{rule}</i> MVEL expressions that are substituted with the template parameters at run-time.</li></ul><ul><li>Line 16: Sets the property <i>doAlert</i> to true to signal the application that the notification rule was fired.</li></ul>Generating a rule from the template is a matter of instantiating&nbsp;<i>ObjectDataCompiler</i>&nbsp;and passing as parameters:<br /><ol><li>A map consisting of a&nbsp;<i>Rule</i> object (e.g.,&nbsp;<i>highValueOrderWidgetsIncRule</i>) and the name of the event class the Rule object pertains to&nbsp;(e.g., <i>org.ossandme.event.OrderEvent</i>)</li><br /><li>The <i>template.drl</i>&nbsp;file</li></ol><script src="https://gist.github.com/claudemamo/50736b6ff70f75ae8bd7.js?file=Program(3).java"></script>Drools cannot evaluate a&nbsp;<i>Rule</i>&nbsp;object<i>&nbsp;</i>in its current POJO form. In order to evaluate it, we override the <i>Rule</i> class's <i>toString()</i> method to transform the POJO into a formal statement:<br /><br /><script src="https://gist.github.com/claudemamo/50736b6ff70f75ae8bd7.js?file=Rule.java"></script>Before running the data through the template, Drools calls <i>toString()</i>&nbsp;on the template parameters. Calling <i>toString()</i> on&nbsp;<i>highValueOrderWidgetsIncRule</i>&nbsp;returns the statement:&nbsp;<i>price &gt; 5000.0 &amp;&amp; customer == 'Widgets Inc.'</i>. Going even further, if&nbsp;we apply the template to the statement&nbsp;and event type <i>OrderEvent</i>, we would get the following generated rule:<br /><br /><script src="https://gist.github.com/claudemamo/50736b6ff70f75ae8bd7.js?file=instance.drl"></script>The last step is to evaluate the rule:<br /><br /><script src="https://gist.github.com/claudemamo/50736b6ff70f75ae8bd7.js?file=Program(4).java"></script>Finally, let's put this all together. Don't worry, <a href="https://github.com/claudemamo/dynamic-drools-rules" target="_blank">a copy of the complete application</a> can be found on GtiHub:<br /><br /><script src="https://gist.github.com/claudemamo/50736b6ff70f75ae8bd7.js?file=Program.java"></script> <br /><div style="text-align: justify;"><span class="num" style="font-family: Times, 'Times New Roman', serif;">1: I'm ignoring the fact that most likely the rule is retrieved from a data store.</span></div>
